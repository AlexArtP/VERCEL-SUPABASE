rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // FUNCIONES AUXILIARES
    // ============================================================================
    
    // Verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verificar si el usuario es admin LEYENDO desde el documento en Firestore
    function isAdminFromFirestore() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.esAdmin == true;
    }
    
    // Obtener el rol del usuario desde Firestore (con manejo de errores)
    function getUserRole() {
      return isAuthenticated() && exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) 
        ? get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol 
        : null;
    }

    // Verificar si usuario es profesional
    function isProfesional() {
      return getUserRole() == 'profesional';
    }

    // Verificar si usuario es administrativo
    function isAdministrativo() {
      return getUserRole() == 'administrativo';
    }
    
    // ============================================================================
    // COLECCIÓN: usuarios
    // Perfiles de usuarios registrados
    // ============================================================================
    
    match /usuarios/{userId} {
      // NOTA IMPORTANTE: Esta regla "allow get" permite que la función isAdminFromFirestore() 
      // lea el documento del usuario cuando se evalúan otras reglas
      allow get: if true;
      
      // Leer:
      // - Admin: puede leer todos los usuarios
      // - Autenticado: puede leer su propio documento
      // - Autenticado: puede leer lista de profesionales activos (para dropdown del calendario)
      allow read: if isAdminFromFirestore() ||
                     (isAuthenticated() && request.auth.uid == userId) ||
                     (isAuthenticated() && resource.data.rol == 'profesional');
      
      // Crear: 
      // - Cualquiera puede crear (para init-demo-admin)
      // - Solo autenticados pueden crear su propio perfil
      allow create: if true;
      
      // Actualizar: 
      // - Permitir actualización del usuario demo sin restricción (para init)
      // - El usuario puede actualizar su propio perfil (excepto esAdmin)
      // - Solo admin puede cambiar esAdmin
      allow update: if userId == 'demo-admin-juan' ||
                       (isAuthenticated() && request.auth.uid == userId && 
                        request.resource.data.keys() == resource.data.keys()) ||
                       isAdminFromFirestore();
      
      // Eliminar: solo admin
      allow delete: if isAdminFromFirestore();
    }
    
    // ============================================================================
    // COLECCIÓN: solicitudRegistro
    // Solicitudes de registro pendientes (nuevo formato)
    // ============================================================================
    
    match /solicitudRegistro/{solicitudId} {
      // Leer: PÚBLICO (necesario para listeners de admin)
      allow read: if true;
      
      // Crear: CUALQUIERA puede crear (público, sin autenticación, para registro)
      allow create: if true;
      
      // Actualizar: SOLO ADMIN puede cambiar estado (aceptar/rechazar)
      allow update: if isAdminFromFirestore();
      
      // Eliminar: Solo admin
      allow delete: if isAdminFromFirestore();
    }
    
    // ============================================================================
    // COLECCIÓN: solicitudes
    // Solicitudes de registro pendientes
    // ============================================================================
    
    match /solicitudes/{solicitudId} {
      // Leer: Permitir lectura pública (necesario para listeners de admin)
      allow read: if true;
      
      // Crear: CUALQUIERA puede crear (público, sin autenticación)
      allow create: if true;
      
      // Actualizar: SOLO ADMIN puede cambiar estado (aceptar/rechazar)
      allow update: if isAdminFromFirestore();
      
      // Eliminar: Solo admin
      allow delete: if isAdminFromFirestore();
    }
    
    // ============================================================================
    // COLECCIÓN: citas
    // Agendamientos/Citas
    // ============================================================================
    
    match /citas/{citaId} {
      // Leer: PÚBLICO para que los listeners funcionen correctamente
      allow read: if true;
      
      // Crear: Profesionales y administrativos pueden crear
      allow create: if isAuthenticated() && (isProfesional() || isAdministrativo());
      
      // Actualizar:
      // - Administrativo: puede editar cualquier cita
      // - Profesional: SOLO citas de sus módulos (donde profesionalId == request.auth.uid)
      allow update: if isAdministrativo() ||
                       (isProfesional() && resource.data.profesionalId == request.auth.uid);
      
      // Eliminar:
      // - Administrativo: puede eliminar cualquier cita
      // - Profesional: SOLO citas de sus módulos
      allow delete: if isAdministrativo() ||
                       (isProfesional() && resource.data.profesionalId == request.auth.uid);
    }
    
    // ============================================================================
    // COLECCIÓN: modulos
    // Módulos de sistemas creados por profesionales/administrativos
    // ============================================================================
    
    match /modulos/{moduloId} {
      // Leer: TODOS LOS AUTENTICADOS pueden leer módulos
      allow read: if isAuthenticated();
      
      // Crear: Profesionales y administrativos pueden crear
      allow create: if isAuthenticated() && (isProfesional() || isAdministrativo());
      
      // Actualizar:
      // - Administrativo: puede editar cualquier módulo
      // - Profesional: SOLO su propio módulo (profesionalId == request.auth.uid)
      allow update: if isAdministrativo() ||
                       (isProfesional() && resource.data.profesionalId == request.auth.uid);
      
      // Eliminar: 
      // - Administrativo: puede eliminar cualquier módulo
      // - Profesional: SOLO su propio módulo
      allow delete: if isAdministrativo() ||
                       (isProfesional() && resource.data.profesionalId == request.auth.uid);
    }
    
    // ============================================================================
    // COLECCIÓN: plantillas
    // Plantillas de citas creadas por profesionales
    // ============================================================================
    
    match /plantillas/{plantillaId} {
      // Leer: autenticados (todos pueden ver las plantillas disponibles)
      allow read: if isAuthenticated();
      
      // Crear: SOLO profesionales y administrativo
      allow create: if isAuthenticated() && 
                       (isAdministrativo() || isProfesional());
      
      // Actualizar: profesional dueño o admin
      allow update: if isAdministrativo() ||
                       (isAuthenticated() &&
                        (resource.data.profesionalId == request.auth.uid ||
                         resource.data.createdBy == request.auth.uid));
      
      // Eliminar: admin o dueño de la plantilla
      allow delete: if isAdministrativo() ||
                       (isAuthenticated() &&
                        (resource.data.profesionalId == request.auth.uid ||
                         resource.data.createdBy == request.auth.uid));
    }
    
    // ============================================================================
    // COLECCIÓN: moduloDefinitions
    // Definiciones de módulos clasificados por estamento (especialidad)
    // ============================================================================
    
    match /moduloDefinitions/{moduloDefId} {
      // Leer: TODOS LOS AUTENTICADOS pueden ver las definiciones de módulos
      // Esto permite que profesionales carguen los módulos según su estamento
      allow read: if isAuthenticated();
      
      // Crear: SOLO administrativos pueden crear definiciones de módulos
      allow create: if isAdministrativo();
      
      // Actualizar: SOLO administrativos pueden editar definiciones
      allow update: if isAdministrativo();
      
      // Eliminar: SOLO administrativos pueden eliminar definiciones
      allow delete: if isAdministrativo();
    }
    
    // ============================================================================
    // COLECCIÓN: pacientes
    // Información de pacientes registrados
    // ============================================================================
    
    match /pacientes/{pacienteId} {
      // Leer: PÚBLICO (cualquier autenticado puede buscar pacientes)
      // En un futuro podría restringirse a profesionales/admin que tiene citas con el paciente
      allow read: if isAuthenticated();
      
      // Crear: SOLO autenticados (profesionales y administrativo crean registros de pacientes)
      allow create: if isAuthenticated() && (isProfesional() || isAdministrativo());
      
      // Actualizar: 
      // - Administrativo: puede editar cualquier paciente
      // - El paciente dueño (pacienteId == request.auth.uid): puede editar su propia info
      // - Profesionales: NO pueden editar info de pacientes
      allow update: if isAdministrativo() ||
                       (isAuthenticated() && request.auth.uid == pacienteId);
      
      // Eliminar: SOLO admin
      allow delete: if isAdministrativo();
    }
    
    // ============================================================================
    // COLECCIÓN: config
    // Configuración
    // ============================================================================
    
    match /config/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdminFromFirestore();
    }
  }
}
