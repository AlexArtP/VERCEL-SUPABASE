rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // FUNCIONES AUXILIARES
    // ============================================================================
    
    // Verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Optimización de funciones auxiliares
    function isAdminFromFirestore() {
      return isAuthenticated() &&
             getUserRole() == 'admin'; // Usar rol directamente en lugar de múltiples lecturas
    }

    function getUserRole() {
      return isAuthenticated() && request.auth.token.role != null
        ? request.auth.token.role // Usar customClaims para roles
        : null;
    }

    // Verificar si usuario es profesional
    function isProfesional() {
      return getUserRole() == 'profesional';
    }

    // Verificar si usuario es administrativo
    function isAdministrativo() {
      return getUserRole() == 'administrativo';
    }
    
    // ============================================================================
    // COLECCIÓN: usuarios
    // Perfiles de usuarios registrados
    // ============================================================================
    
    match /usuarios/{userId} {
      // NOTA IMPORTANTE: Esta regla "allow get" permite que la función isAdminFromFirestore() 
      // lea el documento del usuario cuando se evalúan otras reglas
      allow get: if true;
      
      // Leer (single document - get):
      // - Admin: puede leer todos los usuarios
      // - Autenticado: puede leer su propio documento
      allow read: if isAdminFromFirestore() ||
                     (isAuthenticated() && request.auth.uid == userId) ||
                     (isAuthenticated() && resource.data.rol == 'profesional');

      // List (queries over the collection): permitir que usuarios autenticados
      // obtengan la lista de profesionales activos para poblar dropdowns. Para
      // evitar exponer otros perfiles, sólo permitimos la operación cuando la
      // consulta incluye los filtros esperados: rol == 'profesional' y activo == true.
      // Corregir validación de consultas en usuarios eliminando `where`
      allow list: if isAdminFromFirestore() || (
        isAuthenticated() &&
        request.query.limit <= 50 && // Limitar resultados
        request.query.hasOnly(['rol', 'activo']) && // Validar filtros permitidos
        resource.data.rol == 'profesional' &&
        resource.data.activo == true // Validar directamente los campos
      );
      
      // Crear: 
      // - Cualquiera puede crear (para init-demo-admin)
      // - Solo autenticados pueden crear su propio perfil
      allow create: if request.resource.data.keys().hasAll(['nombre', 'email', 'rol']) &&
                      request.resource.data.rol in ['profesional', 'administrativo'];
      
      // Actualizar: 
      // - Permitir actualización del usuario demo sin restricción (para init)
      // - El usuario puede actualizar su propio perfil (excepto esAdmin)
      // - Solo admin puede cambiar esAdmin
      allow update: if userId == 'demo-admin-juan' ||
                       (isAuthenticated() && request.auth.uid == userId && 
                        request.resource.data.keys() == resource.data.keys()) ||
                       isAdminFromFirestore();
      
      // Eliminar: solo admin
      allow delete: if isAdminFromFirestore();
    }
    
    // ============================================================================
    // COLECCIÓN: solicitudRegistro
    // Solicitudes de registro pendientes (nuevo formato)
    // ============================================================================
    
    match /solicitudRegistro/{solicitudId} {
      // Leer: PÚBLICO (necesario para listeners de admin)
      allow read: if isAdminFromFirestore(); // Restringir lectura pública
      
      // Crear: CUALQUIERA puede crear (público, sin autenticación, para registro)
      allow create: if true;
      
      // Actualizar: SOLO ADMIN puede cambiar estado (aceptar/rechazar)
      allow update: if isAdminFromFirestore();
      
      // Eliminar: Solo admin
      allow delete: if isAdminFromFirestore();
    }
    
    // ============================================================================
    // COLECCIÓN: solicitudes
    // Solicitudes de registro pendientes
    // ============================================================================
    
    match /solicitudes/{solicitudId} {
      // Leer: Permitir lectura pública (necesario para listeners de admin)
      allow read: if isAdminFromFirestore(); // Restringir lectura pública
      
      // Crear: CUALQUIERA puede crear (público, sin autenticación)
      allow create: if true;
      
      // Actualizar: SOLO ADMIN puede cambiar estado (aceptar/rechazar)
      allow update: if isAdminFromFirestore();
      
      // Eliminar: Solo admin
      allow delete: if isAdminFromFirestore();
    }
    
    // ============================================================================
    // COLECCIÓN: citas
    // Agendamientos/Citas
    // ============================================================================
    
    match /citas/{citaId} {
      // Leer: PÚBLICO para que los listeners funcionen correctamente
      allow read: if true;
      
      // Crear: 
      // - Admin (esAdmin=true): puede crear en cualquier agenda
      // - Administrativo: puede crear en cualquier agenda
      // - Profesional: SOLO puede crear en su propia agenda (profesionalId == request.auth.uid)
      allow create: if isAuthenticated() && (
        isAdministrativo() ||
        isAdminFromFirestore() ||
        (isProfesional() && request.resource.data.profesionalId == request.auth.uid)
      );
      
      // Actualizar:
      // - Admin (esAdmin=true): puede editar cualquier cita
      // - Administrativo: puede editar cualquier cita
      // - Profesional: SOLO citas de su propia agenda (profesionalId == request.auth.uid)
      allow update: if isAdministrativo() ||
                       isAdminFromFirestore() ||
                       (isProfesional() && resource.data.profesionalId == request.auth.uid);
      
      // Eliminar:
      // - Admin (esAdmin=true): puede eliminar cualquier cita
      // - Administrativo: puede eliminar cualquier cita
      // - Profesional: SOLO citas de su propia agenda (profesionalId == request.auth.uid)
      allow delete: if isAdministrativo() ||
                       isAdminFromFirestore() ||
                       (isProfesional() && resource.data.profesionalId == request.auth.uid);
    }
    
    // ============================================================================
    // COLECCIÓN: modulos
    // Módulos de sistemas creados por profesionales/administrativos
    // ============================================================================
    
    match /modulos/{moduloId} {
      // Leer: TODOS LOS AUTENTICADOS pueden leer módulos
      allow read: if isAuthenticated();

      // Crear:
      // - Admin (esAdmin=true): puede crear en cualquier agenda
      // - Administrativo: puede crear en cualquier agenda
      // - Profesional: SOLO puede crear módulos en su propia agenda (profesionalId == request.auth.uid)
      allow create: if isAdministrativo() ||
        isAdminFromFirestore() ||
        (isProfesional() && request.resource.data.profesionalId == request.auth.uid);

      // Actualizar:
      // - Admin (esAdmin=true): puede editar cualquier módulo
      // - Administrativo: puede editar cualquier módulo
      // - Profesional: SOLO puede editar módulos en su propia agenda (profesionalId == request.auth.uid)
      allow update: if isAdministrativo() ||
        isAdminFromFirestore() ||
        (isProfesional() && resource.data.profesionalId == request.auth.uid);

      // Eliminar:
      // - Admin (esAdmin=true): puede eliminar cualquier módulo
      // - Administrativo: puede eliminar cualquier módulo
      // - Profesional: SOLO puede eliminar módulos en su propia agenda (profesionalId == request.auth.uid)
      allow delete: if isAdministrativo() ||
        isAdminFromFirestore() ||
        (isProfesional() && resource.data.profesionalId == request.auth.uid);
    }
    
    // ============================================================================
    // COLECCIÓN: plantillas
    // Plantillas de citas creadas por profesionales
    // ============================================================================
    
    match /plantillas/{plantillaId} {
      // Leer: autenticados (todos pueden ver las plantillas disponibles)
      allow read: if isAuthenticated();
      
      // Crear: SOLO profesionales y administrativo
      allow create: if isAuthenticated() && 
                       (isAdministrativo() || isProfesional());
      
      // Actualizar: profesional dueño o admin
      allow update: if isAdministrativo() ||
                       (isAuthenticated() &&
                        (resource.data.profesionalId == request.auth.uid ||
                         resource.data.createdBy == request.auth.uid));
      
      // Eliminar: admin o dueño de la plantilla
      allow delete: if isAdministrativo() ||
                       (isAuthenticated() &&
                        (resource.data.profesionalId == request.auth.uid ||
                         resource.data.createdBy == request.auth.uid));
    }
    
    // ============================================================================
    // COLECCIÓN: moduloDefinitions
    // Definiciones de módulos clasificados por estamento (especialidad)
    // ============================================================================
    
    match /moduloDefinitions/{moduloDefId} {
      // Leer: TODOS LOS AUTENTICADOS pueden ver las definiciones de módulos
      // Esto permite que profesionales carguen los módulos según su estamento
      allow read: if isAuthenticated();
      
      // Crear: Administrativos y profesionales pueden crear definiciones de módulos
      // (los profesionales crean sus propias plantillas / definiciones)
      allow create: if isAdministrativo() || isProfesional();

      // Actualizar: Administrativo o el propietario (profesionalId o createdBy)
      allow update: if isAdministrativo() || (
        isAuthenticated() && (
          resource.data.profesionalId == request.auth.uid ||
          resource.data.createdBy == request.auth.uid
        )
      );

      // Eliminar: Administrativo o el propietario
      allow delete: if isAdministrativo() || (
        isAuthenticated() && (
          resource.data.profesionalId == request.auth.uid ||
          resource.data.createdBy == request.auth.uid
        )
      );
    }
    
    // ============================================================================
    // COLECCIÓN: pacientes
    // Información de pacientes registrados
    // ============================================================================
    
    match /pacientes/{pacienteId} {
      // Leer: PÚBLICO (cualquier autenticado puede buscar pacientes)
      // En un futuro podría restringirse a profesionales/admin que tiene citas con el paciente
      allow read: if isAuthenticated();
      
      // Crear: SOLO autenticados (profesionales y administrativo crean registros de pacientes)
      allow create: if isAuthenticated() && (isProfesional() || isAdministrativo());
      
      // Actualizar: 
      // - Administrativo: puede editar cualquier paciente
      // - El paciente dueño (pacienteId == request.auth.uid): puede editar su propia info
      // - Profesionales: NO pueden editar info de pacientes
      allow update: if isAdministrativo() ||
                       (isAuthenticated() && request.auth.uid == pacienteId);
      
      // Eliminar: SOLO admin
      allow delete: if isAdministrativo();
    }
    
    // ============================================================================
    // COLECCIÓN: config
    // Configuración
    // ============================================================================
    
    match /config/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdminFromFirestore();
    }
  }
}
